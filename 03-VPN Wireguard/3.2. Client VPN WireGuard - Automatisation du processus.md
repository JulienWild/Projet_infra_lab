

> En tant que formateur, tu dois dÃ©ployer des configurations VPN WireGuard pour tes Ã©lÃ¨ves.
> Pour t'aider dans cette tÃ¢che, nous avons crÃ©Ã© des scripts pour automatiser toute cette partie.
> Tu trouveras ce projet dans [ce dÃ©pÃ´t GitHub public](https://github.com/JulienWild/Client_VPN_WireGuard).


Voici le fichier README.md de ce dÃ©pÃ´t :


<h1 align="center">

ğŸ› ï¸ Script d'automatisation de gÃ©nÃ©ration des configurations des clients VPN WireGuard - Guide pour les Formateurs

</h1>

  

## Table of contents

  

- [ğŸš€ Bienvenue !](#-bienvenue-)
- [ğŸ—ï¸ FonctionnalitÃ©s principales](#ï¸-fonctionnalitÃ©s-principales)
- [ğŸ“‚ PrÃ©paration de l'environnement](#-prÃ©paration-de-lenvironnement)
- [ğŸ“š Structure du dÃ©pÃ´t](#-structure-du-dÃ©pÃ´t)
- [ğŸ’» Comment utiliser le scriptâ€¯?](#-comment-utiliser-le-script)
   - [ğŸ› ï¸ Ã‰tape 1 : PrÃ©parer lâ€™environnement](#ï¸-Ã©tape-1--prÃ©parer-lenvironnement)
   - [ğŸ› ï¸ Ã‰tape 2 : Lancer le script](#ï¸-Ã©tape-2--lancer-le-script)
- [ğŸ¯ RÃ©sultat attendu](#-rÃ©sultat-attendu)
- [ğŸ“¤ Transmission des fichiers aux Ã©lÃ¨ves](#-transmission-des-fichiers-aux-Ã©lÃ¨ves)
   - [ğŸ“¦ Ã‰tape 1 : Envoyer l'archive chiffrÃ©e (.tar.gz.gpg)](#-Ã©tape-1--envoyer-larchive-chiffrÃ©e-targzgpg)
   - [ğŸ“œ Ã‰tape 2 : Transmettre la procÃ©dure et le mot de passe](#-Ã©tape-2--transmettre-la-procÃ©dure-et-le-mot-de-passe)
- [ğŸš¦ ProcÃ©dures supplÃ©mentaires](#-procÃ©dures-supplÃ©mentaires)
   - [â›µ Ajout d'un nouvel Ã©quipage ?](#-ajout-dun-nouvel-Ã©quipage-)
   - [ğŸ†• RÃ©initialiser complÃ¨tement le script](#-rÃ©initialiser-complÃ¨tement-le-script)
   - [âŒ Supprimer un seul Ã©lÃ¨ve](#-supprimer-un-seul-Ã©lÃ¨ve)
- [ğŸ“¬ En cas de problÃ¨me ?](#-en-cas-de-problÃ¨me-)

---
## ğŸš€ Bienvenue !

Ce script a Ã©tÃ© conÃ§u pour automatiser la configuration des clients VPN **WireGuard** afin de simplifier le dÃ©ploiement dans un contexte pÃ©dagogique.

Il prend en charge :
- La **gÃ©nÃ©ration des clÃ©s publiques et privÃ©es** pour chaque wilder.
- La crÃ©ation d'une **procÃ©dure personnalisÃ©e** adaptÃ©e Ã  chaque wilder.
- La gÃ©nÃ©ration d'une archive chiffrÃ©e contenant les clÃ©s et la procÃ©dure, protÃ©gÃ©e par un mot de passe.

Le script est conÃ§u pour Ãªtre utilisÃ© dans des environnements **Linux** et **Windows**.


---


## ğŸ—ï¸ FonctionnalitÃ©s principales

### âœ… Ce que fait le script :

1. **GÃ©nÃ©ration des clÃ©s WireGuard** :
	- GÃ©nÃ¨re une clÃ© publique et une clÃ© privÃ©e pour chaque wilder dÃ©clarÃ© dans un fichier.
2. **CrÃ©ation de la procÃ©dure utilisateur** :
	- Produit un fichier de procÃ©dure personnalisÃ© au format Markdown (`.md`) contenant les informations nÃ©cessaires pour configurer le VPN.
3. **Chiffrement des fichiers sensibles** :
	- Archive et chiffre les clÃ©s dans un fichier `.tar.gz.gpg` protÃ©gÃ© par un mot de passe.
4. **Suppression sÃ©curisÃ©e de la clÃ© privÃ©e** :
	- AprÃ¨s la crÃ©ation de l'archive, la clÃ© privÃ©e en clair est automatiquement supprimÃ©e.

  
---

## ğŸ“‚ PrÃ©paration de l'environnement

### ğŸ–¥ï¸ PrÃ©requis pour Windows et Linux


1. **Git** : Pour cloner le dÃ©pÃ´t contenant le script.
2. **GPG** : Pour le chiffrement des fichiers (installÃ© par dÃ©faut sur la plupart des distributions Linux).
3. **Un shell compatible Bash** :
	- **Windows** : Utilise [Git Bash](https://git-scm.com/downloads/win).
	- **Linux** : Le shell Bash est installÃ© par dÃ©faut.

  
## ğŸ“š Structure du dÃ©pÃ´t

Voici un aperÃ§u de la structure des fichiers dans le dÃ©pÃ´t Git aprÃ¨s clonage :


```bash

Client_VPN_WireGuard

â”œâ”€â”€ setup_vpn_wireguard.sh # Script principal
â”œâ”€â”€ vpn_config.sh # Fichier de configuration des variables
â”œâ”€â”€ wilders.csv # Liste des wilders
â”œâ”€â”€ template-procedure.txt # ModÃ¨le de procÃ©dure pour les wilders
â””â”€â”€ README.md # Cette documentation du script
```

  
---
## ğŸ’» Comment utiliser le scriptâ€¯?

Pour les Ã©tapes dÃ©taillÃ©es, consulte la section [Utilisation du script](#-utilisation-du-script).

---
## ğŸ”§ Configuration du script

### âœï¸ Configuration des variables

âœ¨ Avant d'utiliser le script, il est important de configurer les variables nÃ©cessaires dans le fichier `vpn_config.sh`.

Ce fichier contient toutes les variables nÃ©cessaires pour personnaliser le dÃ©ploiement.

Le script Ã  Ã©tÃ© pensÃ© pour fonctionner avec un sous-rÃ©seau de VPN utilisant un **masque CIDR `/16`** .
Dans mon cas, j'utilise le sous-rÃ©seau `172.31`, et ceci pour plusieurs raisons :

* Le sous-rÃ©seau de VPN ne doit Ãªtre utilisÃ© par aucun cotÃ© du tunnel, que ce soit chez les Ã©lÃ¨ves, ou dans le LAN pfSense. Il y a peu de chance que les Ã©lÃ¨ves utilisent un sous-rÃ©seau `172.31.x.x/16` chez eux.

* Je me sert du 3 eme octet pour identifier le crew, et du 4 eme octet pour identifier l'Ã©lÃ¨ve. Ainsi, chaque crew dispose des mÃªmes 3 premiers octets.


>Cette partie necessiterai sÃ»rement une amÃ©lioration, afin de correspondre Ã  plusieurs scÃ©narios d'utilisation du tunnel VPN.


### ğŸŒŸ Variables Ã  modifier :


- **`SERVER_PUBLIC_KEY`** : ClÃ© publique du serveur WireGuard. A RECUPERER SUR LE SERVEUR WIREGUARD

- **`SERVER_TUNNEL_IP`** : Adresse IP du tunnel (ex. "172.31.255.254/32"). (il faut dÃ©clarer l'interface, et donc utiliser un masque /32) A RECUPERER SUR LE SERVEUR WIREGUARD

- **`VPN_SUBNET`** : Sous-rÃ©seau accessible via le VPN (ex. "192.168.50.0/24"). En gros, le sous-rÃ©seau LAN de ton firewall pfSense

- **`VPN_ENDPOINT_IP`** : Adresse IPv4 publique du serveur VPN (ex. "203.0.113.10"). C'est l'adressse de ton serveur Proxmox VE

- **`TUNNEL_MASK`** : Masque de rÃ©seau du tunnel WireGuard (ex. "/16").

- **`DNS`** : Adresse de l'interface LAN de pfsense, pour que les clients VPN l'utilisent comme premier serveur DNS (ex. "192.168.50.254").

- **`BASE_IP`** : Base pour les adresses des clients VPN. En fonction de la valeur de la variable `$TUNNEL_MASK` que tu as renseignÃ© (ex. "172.31"). Cette variable va servir Ã  gÃ©nÃ©rer des adresses IP pour les clients VPN, et maintiendra Ã  jour les adresses dÃ©jÃ  utilisÃ©es dans un fichier gÃ©nÃ©rÃ© automatiquement par le script (fichier `ip.txt`).



âœ¨ Voici un exemple de fichier `vpn_config.sh` :

```bash
#!/bin/bash

# RÃ©pertoire de travail
WORKDIR=$(pwd)

# Fichiers
CSV_FILE="$WORKDIR/wilders.csv" # Fichier contenant les informations des Wilders
IP_FILE="$WORKDIR/ip.txt" # Fichier pour suivre les adresses IP attribuÃ©es
TEMPLATE_FILE="$WORKDIR/template-procedure.md" # ModÃ¨le de procÃ©dure pour les Ã©lÃ¨ves
OUTPUT_DIR="$WORKDIR/output" # RÃ©pertoire de sortie pour les fichiers gÃ©nÃ©rÃ©s

# Informations WireGuard
SERVER_PUBLIC_KEY="KyD5aC8qZaZqNJ53wtg4s2vJOyEwo5HrGAGUjE7+qQQ="
SERVER_TUNNEL_IP="172.31.255.254/32"
VPN_SUBNET="192.168.50.0/24"
VPN_ENDPOINT_IP="144.76.100.132"
TUNNEL_MASK="/16"
DNS="192.168.50.254"

# Variables rÃ©seau
BASE_IP="172.31" # Base pour les adresses VPN (172.31.x.y)
```

  
### âœï¸ DÃ©claration des Ã©lÃ¨ves dans le fichier `wilders.csv`


Le fichier `wilders.csv` contient les informations sur les Ã©lÃ¨ves. Il est utilisÃ© pour gÃ©nÃ©rer les configurations VPN pour chacun d'eux.


```csv
crew,prenom,nom
1,Jean,jacques
1,Jean,Marc
2,Jean,Pierre
```

  
- **`crew`**: Identifiant du groupe. Les valeurs doivent Ãªtres comprises entre `0` et `254` (`255` Ã©tant utilisÃ© pour l'interface de tunnel du serveur), car cette valeur va dÃ©terminer le 3 eme octet des adresses IPv4 pour les clients VPN. J'ai pensÃ© le script pour utiliser par exemple la valeur `0` pour les formateurs, la valeur `1` pour ton premier groupe de wilder, la valeur `2` pour ton second groupe etc...

- **`prenom`** et **`nom`**: PrÃ©nom et nom de l'Ã©lÃ¨ve.

  
> N'oublie pas de te rajouter !

  

---

  

## ğŸ“„ Utilisation du script

### ğŸ› ï¸ Ã‰tape 1 : PrÃ©pare lâ€™environnement


1. âœ¨ **Clone le dÃ©pÃ´t dans un rÃ©pertoire de travail :**

```bash
git clone git@github.com:JulienWild/Client_VPN_WireGuard.git
cd Client_VPN_WireGuard
```

  
2. âœ¨ **Ouvre le fichier `vpn_config.sh` et dÃ©clare les variables pour qu'elles correspondent Ã  ta configuration :**

```bash
nano vpn_config.sh
```

  

3. âœ¨ **Rends les scripts exÃ©cutables :**

```bash
chmod +x setup_vpn_wireguard.sh
chmod +x vpn_config.sh
```

4. âœ¨ **Ajoute les utilisateurs dans le fichier `wilders.csv` :**

```csv
crew,prenom,nom
0,Julien,Gregoire
1,Jean,jacques
1,Jean,Marc
2,Jean,Pierre
```

  

---

  

### ğŸ› ï¸ Ã‰tape 2 : Lance le script

```bash
sudo ./setup_vpn_wireguard.sh
```

> Le script doit Ãªtre jouÃ© avec les droits **root**.

Arborescence repertoire aprÃ¨s exÃ©cution du script :

  

```bash
.
â”œâ”€â”€ ip.txt
â”œâ”€â”€ output
â”‚Â Â  â”œâ”€â”€ Jean_jacques
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_jacques_keys.tar.gz.gpg
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_jacques_WIREGUARD-public.key
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ password.txt
â”‚Â Â  â”‚Â Â  â””â”€â”€ procedure.md
â”‚Â Â  â”œâ”€â”€ Jean_Marc
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_Marc_keys.tar.gz.gpg
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_Marc_WIREGUARD-public.key
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ password.txt
â”‚Â Â  â”‚Â Â  â””â”€â”€ procedure.md
â”‚Â Â  â”œâ”€â”€ Jean_Pierre
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_Pierre_keys.tar.gz.gpg
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Jean_Pierre_WIREGUARD-public.key
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ password.txt
â”‚Â Â  â”‚Â Â  â””â”€â”€ procedure.md
â”‚Â Â  â””â”€â”€ Julien_Gregoire
â”‚Â Â  â”œâ”€â”€ Julien_Gregoire _keys.tar.gz.gpg
â”‚Â Â  â”œâ”€â”€ Julien_Gregoire _WIREGUARD-public.key
â”‚Â Â  â”œâ”€â”€ password.txt
â”‚Â Â  â””â”€â”€ procedure.md
â”œâ”€â”€ README.md
â”œâ”€â”€ setup_vpn_wireguard.sh
â”œâ”€â”€ template-procedure.md
â”œâ”€â”€ vpn_config.sh
â””â”€â”€ wilders.csv

```

  

---

  

## ğŸ¯ RÃ©sultat attendu

Une fois le script exÃ©cutÃ©, les Ã©lÃ©ments suivants seront gÃ©nÃ©rÃ©s pour chaque utilisateur dans le rÃ©pertoire output/<Nom_Utilisateur>:

* **ClÃ© publique et privÃ©e** (clÃ© privÃ©e supprimÃ©e aprÃ¨s archivage et chiffrement).
* **ProcÃ©dure personnalisÃ©e** : Fichier Markdown contenant les Ã©tapes de configuration du VPN pour chaque wilder.
* **Archive chiffrÃ©e** : Contient la clÃ© publique et la clÃ© privÃ©e.

> La procÃ©dure gÃ©nÃ©rÃ©e indique Ã  chaque wilder comment extraire l'archive chiffrÃ©e, et comment configuer son client VPN WireGuard.

***Le script crÃ©e aussi un fichier `ip.txt` pour suivre les adresses IPv4 de tunnel des clients dÃ©jÃ  utilisÃ©es, afin de ne pas faire de doublons. (CrÃ©e le fichier seulement la premiÃ¨re fois qu'on exÃ©cute le script ...)***

Exemple de fichier `ip.txt` gÃ©nÃ©rÃ© :

```
0 Julien_Gregoire 172.31.0.1
1 Jean_jacques 172.31.1.1
1 Jean_Marc 172.31.1.2
2 Jean_Pierre 172.31.2.1
```

  
---


# ğŸ“¤ Transmission des fichiers aux Ã©lÃ¨ves

Une fois les fichiers gÃ©nÃ©rÃ©s par le script, il est essentiel de les transmettre aux Ã©lÃ¨ves en respectant les bonnes pratiques de sÃ©curitÃ© .


Pour Ã©viter toute compromission, l'archive chiffrÃ©e, la procÃ©dure et le fichier contenant le mot de passe **ne doivent pas Ãªtre envoyÃ©s via le mÃªme canal de communication**.


ğŸ“¦ **Ã‰tape 1 : Envoyer l'archive chiffrÃ©e ( .tar.gz.gpg)**

1. Envoie l'archive contenant les clÃ©s WireGuard (.tar.gz.gpg) Ã  l'Ã©lÃ¨ve via un canal sÃ©curisÃ© comme Slack.

2. Informe l'Ã©lÃ¨ve que l'archive est protÃ©gÃ©e par un mot de passe et que les instructions pour l'extraction suivront via un autre canal.

ğŸ“œ **Ã‰tape 2 : Transmettre la procÃ©dure et le mot de passe**

Envoie la procÃ©dure personnalisÃ©e (procedure.md) et le mot de passe (password.txt) via un canal diffÃ©rent de celui utilisÃ© pour transmettre l'archive (par exemple, par email si l'archive a Ã©tÃ© envoyÃ©e via Slack).

ğŸ’¡ Bonnes pratiques :

* ğŸ›¡ï¸ SÃ©paration des canaux : Le mot de passe ne doit jamais transiter par le mÃªme canal que l'archive.
* ğŸ”’ ConfidentialitÃ© des fichiers : Assure-toi que seuls les Ã©lÃ¨ves concernÃ©s ont accÃ¨s aux fichiers.
* ğŸ”„ Validation de rÃ©ception : Demande aux Ã©lÃ¨ves de confirmer la rÃ©ception de l'archive, de la procÃ©dure, et du mot de passe.

---

## ğŸš¦ ProcÃ©dures supplÃ©mentaires

# â›µ Ajout d'un nouvel Ã©quipage ?

Si tu accueilles un nouveau crew dans quelques semaines ou mois, il te suffit de mettre Ã  jour le fichier `wilders.csv` en y ajoutant les informations des nouveaux wilders, puis de relancer le script.

âš™ï¸ Le script est conÃ§u pour Ã©viter les doublons : si un wilder est dÃ©jÃ  configurÃ©, ses fichiers ne seront pas recrÃ©Ã©s ni Ã©crasÃ©s.

---

## ğŸ†• RÃ©initialiser complÃ¨tement le script

Si tu souhaites repartir de zÃ©ro pour une raison particuliÃ¨re (par exemple, pour tester ou corriger un problÃ¨me), voici les Ã©tapes Ã  suivre :

1. Supprime le fichier contenant les adresses IP dÃ©jÃ  attribuÃ©es :

```bash
sudo rm ip.txt
```


2. Supprime Ã©galement le rÃ©pertoire contenant les fichiers gÃ©nÃ©rÃ©s :
```bash
sudo rm -rf output
```

  
>âš ï¸ Attention : RÃ©initialiser efface tout l'historique.
>Les adresses IPv4 dÃ©jÃ  attribuÃ©es ne seront plus suivies.
>Les clÃ©s gÃ©nÃ©rÃ©es pour les tunnels VPN seront dÃ©finitivement perdues.
>Cette procÃ©dure est Ã  utiliser uniquement dans un contexte de test ou de dÃ©veloppement. En production , il est fortement dÃ©conseillÃ© de rÃ©aliser cette rÃ©initialisation.


---
## âŒ Supprimer un seul Ã©lÃ¨ve

Si tu as besoin de supprimer un Ã©lÃ¨ve spÃ©cifique tout en conservant les donnÃ©es des autres, voici comment procÃ©der :

1. Supprime son nom de fichier `wilders.csv`

2. Supprime la ligne associÃ©e Ã  cet Ã©lÃ¨ve dans le fichier `ip.txt`

3. Supprime son dossier dans le rÃ©pertoire `output` :

```bash
sudo rm -rf output/<Nom_Utilisateur>
```

  
---

# ğŸ“¬ En cas de problÃ¨me ?

- **Besoin d'aide ?** : Contacte l'administrateur ou ouvre un ticket sur le dÃ©pÃ´t Git.

