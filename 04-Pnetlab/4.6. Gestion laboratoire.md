
## Sessions de laboratoires

Sources : https://www.pnetlab.com/pages/documentation?slug=manage-running-labs

Lorsqu'un wilder ouvre un laboratoire, une session de laboratoire est créée. Le wilder deviendra l'hôte de la session du laboratoire. 
Si plusieurs wilders ouvrent le même laboratoire, une session est crée pour chacun d'eux.

![[Pasted image 20241219071847.png]]


On voit qui est l'utilisateur qui est l'hôte de la session dans la colonne **Session Host**.

Pour chaque session de laboratoire, on peut effectuer plusieurs actions :
* Obtenir des informations sur le laboratoire en cliquant sur la colonne **Session Lab Path**
* Rejoindre la session en cliquant sur l'icone correspondant dans la colonne **Actions**
- Détruire la session en cliquant sur l'icone correspondant dans la colonne **Actions**. Seul l'hôte de session et l'admin peuvent détruire un laboratoire.

✨ **Ne crée pas de nouvelle session, rejoint plutôt le session de ton collègue, celui qui a ouvert le laboratoire, et qui est donc, de facto, l'hôte de session. Organisez-vous entre vous pour cette action.**

Lorsque tu arrêtes tous les noeuds du laboratoire, le status passe à arrêté, on le voit avec le carré rouge.

Le problème c'est que chaque session ouverte est un delta du laboratoire originel, une copie du laboratoire dans la session de l'hôte. 
Donc, lorsque tu effectues des configurations dans la session, les configurations ne sont pas enregistrées dans le laboratoire d'origine. 
Pour ceux qui sont familiers avec le matériel Cisco (et d'autres constructeurs au demeurant ...), le fonctionnement est un peu similaire  à la running-config et la startup-config.

En fait, les configurations sont stockées dans des fichiers tmp . Ce fichiers tmp sont détruits seulement lorsqu'on détruit la session de laboratoire, et pas quand on arrête les noeuds (normalement). 

Lorsqu'on détruit une session de laboratoire pour libérer des ressources du serveur PnetLab, toutes les configurations sont perdues (fichiers de delta tmp). Il est nécessaire d'exporter la configuration avant suppression, afin que les fichiers tmp soient agrégés au laboratoire. 


## Exporter les configurations
Sources : https://www.pnetlab.com/pages/documentation?slug=how-to-save-configuration-of-lab

Pour que tes configurations s'enregistrent, et que les autres membre de l'équipe voient les changements, il faut que tu **exportes les configurations de toutes les machines modifiées**.

## Machines de type dynamips
✨ Clique sur **Setup Nodes** > puis sur **Export all CFGs** > attends de recevoir les messages de réussite :

![[Pasted image 20241219074911.png]]


![[Pasted image 20241219074918.png]]


✨ Vérifie que les configurations sont bien enregistrées dans la configuration de démarrage. Pour celà, ferme toutes les fenêtres de terminal, ou VNC, puis va dans l'onglet **Configuration de démarrage** pour voir la configuration que tu viens d'exporter.

![[Pasted image 20241219075107.png]]


✨ Clique sur le bouton **Activer** pour activer la configuration de démarrage de tous les appareils :

![[Pasted image 20241219075139.png]]


## Enregistrer la configuration des machines Docker et Qemu )

Sources : https://pnetlab.com/pages/documentation?slug=commit-image-docker-and-qemu

Il est nécessaire que tu sois **admin** afin de pouvoir réaliser un commit.

Attention, Docker et les machines basées sur Qemu (VM, switchs/routeurs basés sur Linux (viosl)) ne prennent pas en charge l'exportation de configuration. 

La procédure pour enregistrer tes modifications dans le noeud de la maquette est la suivante :

1. Déploie un noeud parmi la liste des machines disponibles, puis réalise tes modifications (configurations)
2. Lorsque tu estimes que tes configurations sont terminées, ou que tu souhaites enregistrer ton travail, il est nécessaire de réaliser un commit. Pour se faire, fait un clic droit sur ton noeud et sélectionne **Node Commit**

![[Sélection_137.png]]

3. Tu as 3 options pour le commit :

* ✨ **Valider l'image d'origine (Commit to original Image) :** applique toutes les modifications de ce nœud à l'image d'origine. 
> Notes :
> Si tu choisis **de valider l'image d'origine** , l'image d'origine sera modifiée et ne sera plus disponible. Cette option me semble très risquée.

![[Pasted image 20241220073323.png]]

- ✨ **Prendre un instantané à partir de l'image d'origine (Take Snapshot from original Image) :** enregistre l'état actuel de ce nœud en tant que nouveau périphérique. 
> Notes :
> L'instantané ne peut pas fonctionner **sans l'image d'origine**. Si tu choisis **de prendre un instantané à partir de l'image d'origine**, le système enregistrera automatiquement l'état actuel en tant que nouvel appareil et tu pourras utiliser cet appareil comme n'importe quel autre. Tu dois définir le nom du nouvel instantané. Ce "nouveau périphérique" sera visible et utilisable par tout le monde sur n'importe quelle maquette ... Donc le nom que tu vas lui donner est très important, et ça peut vite devenir incompréhensible. 

![[Pasted image 20241220073845.png]]

- ✨ **Créer une image complètement nouvelle (Create a completely new Image) :** enregistre l'état actuel de ce nœud en tant que périphérique complètement nouveau. Peut fonctionner indépendamment de l'image d'origine. Cependant, cela nécessitera plus d'espace disque. **(Qemu uniquement)**
> Notes :
	* Cette image peut fonctionner indépendamment même si l'original a été supprimé.
	* Le disque dur nécessaire pour enregistrer les nouvelles images sera beaucoup plus grand que celui des instantanés
	* Il te faudra aussi choisir un nom pour ce nouveau périphérique

![[Pasted image 20241220073907.png]]

Pour moi, il faut privilégier le snapshot ou la création d'une nouvelle machine selon les cas. Petite préférence sur la création d'une nouvelle machine car, même si la taille est plus conséquente, on saît tous que l'utilisation de snapshot réduit les performances.


Cette façon de procédé est une contrainte forte sur l'utilisation de cet outils je trouve ...

4. Maintenant il faut utiliser cette nouvelle configuration. Là aussi, la procédure est un peu déroutante. Prenons l'exemple de la création d'une nouvelle machine Linux, basée sur l'image serveur Linux (linux-debian12-Server), et portant le nom de TestJulien. Pour utiliser ma machine modifié, va dans sa configuration, et choisis ton image :

![[Pasted image 20241220074941.png]]

5. Le système t'informe qu'il est nécessaire de **Wipe** avant de prendre effet. Donc enregistre la config, puis effectue un clic droit sur ton noeud afin de sélectionner l'option **Wipe** puis confirme :

![[Sélection_142.png]]

6. Le fait de **Wipe** éteint ta machine. Au redémarrage, c'est ta nouvelle machine. 


---

## Formateur seulement

Un des problèmes que je vois à cette façon de travailler, est la multiplication des images ou snapshots.

L'administrateur devra régulièrement nettoyer les images inutilisées :

✨ Liste des machines Qemu :
```bash
root@pnetlab:/opt/unetlab/addons/qemu# ls -l
total 60
drwxr-xr-x 2 root     root     4096 déc.  15 11:16 iosvl2-2020
drwxr-xr-x 2 root     root     4096 déc.  12 11:04 linux-debian12-Desktop
drwxr-xr-x 2 root     root     4096 déc.  12 11:17 linux-debian12-Server
drwxr-xr-x 2 www-data www-data 4096 déc.  19 16:02 linux-Mise_en_place_GLPI1
drwxr-xr-x 2 www-data www-data 4096 déc.  20 06:45 linux-TestJulien
drwxr-xr-x 2 root     root     4096 déc.  12 13:28 linux-xivo
drwxr-xr-x 2 root     root     4096 déc.  10 16:06 opnsense-24.7
drwxr-xr-x 2 root     root     4096 déc.  11 06:28 pfsense-2.7.1
drwxr-xr-x 2 root     root     4096 déc.  11 06:39 utm-4.3.16
drwxr-xr-x 2 root     root     4096 déc.  15 11:11 viosl2-adventerprisek9-m.ssa.high_iron_20200929
drwxr-xr-x 2 root     root     4096 déc.  12 11:50 win-10pro-sysprep
drwxr-xr-x 2 root     root     4096 déc.  12 10:18 winserver-2019
drwxr-xr-x 2 root     root     4096 déc.  12 12:50 winserver-2019-sysprep
drwxr-xr-x 2 root     root     4096 déc.  11 13:04 winserver-2022
drwxr-xr-x 2 www-data www-data 4096 déc.  19 16:14 winserver-G1_mise_en_place_AD__DNS_DHCP
```

✨ Suppression d'une machine :
```bash
root@pnetlab:/opt/unetlab/addons/qemu# rm -rf linux-TestJulien
```

La machine n'est plus disponible et l'espace disque est libéré.

### Convention 

Il faut imposer une certaine rigueur de convention de nommage afin de maintenir un serveur performant en nettoyant les machines .

Je propose que chaque groupe formalise le nom de leur machine en rajoutant à la fin

G<1/2>-v<1.0>

Ainsi, en un coup d'oeil, on voit si la machine est a destination du groupe 1 (G1) ou du groupe 2 (G2) et on voit aussi la version : v 1.0 => v1.1 => v1.2 => v.2.0 => v2.1 .... et le formateur pourra nettoyer les anciennes versions.

Exemple :

ADDS-G1-v1.0

PS : Le nom affiché dans la maquette et le nom de l'image peut être différent. Utilisez votre propre convention de nommage de projet pour le nom affiché :

![[Sélection_143.png]]



