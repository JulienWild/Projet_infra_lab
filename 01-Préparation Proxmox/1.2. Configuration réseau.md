
Une des contraintes forte qui apparaît dès le début du projet est que notre hébergeur ne nous fourni qu'une unique adresse IPv4 pour ce serveur dédié.

>Problématique : ***comment les vm vont pouvoir accéder à Internet, s'il n'y a qu'une seule adresse IPv4 ?***

>Solution : utiliser la fonctionnalité de NAT, afin que toutes les VM utilisent l'unique adresse IPv4 publique pour accéder à Internet.

Le choix à été fait de déployer une machine virtuelle pfSense, qui fait office de routeur (et donc de NAT en IPv4) entre son réseau LAN dans lequel sera instancié la VM de laboratoire PnetLab, et son réseau WAN, qui utilise le réseau physique fourni par le fournisseur HETZNER.


Pour IPv6 c'est différent.
Par défaut, HETZNER ne fournit qu'un préfixe /64 pour l'IPv6.

>Comme j'ai besoin de créer des sous réseaux IPv6 (un sous-réseau IPv6 pour le réseau WAN de pfSense, et un sous-réseau IPv6 pour le réseau LAN de pfsense), il faut faire une demande de préfixe /56 à HETZNER, en passant par Romain.

Une fois fait, HETZNER me fourni une adresse IPv6 pour l’interface physique du serveur Proxmox (`enp8s0`) + un préfixe IPv6 en /56 (`2a01:4f8:192:4600::/56`) . Les adresses ne sont pas dans le même préfixe que l'adresse IPv6 d'administration du noeud.

Dans mon cas, l'adresse IPv6 de l'interface physique Proxmox (`enp8s0`) est `2a01:4f8:192:4082::2/56` (gateway `fe80::1`) et son adresse IPv4 est `144.76.100.132/27` (gateway `144.76.100.129` )

![[Pasted image 20241204143619.png]]


Il est nécessaire de créer et configurer 2 carte virtuelles (vmbr1 et vmbr2), qui seront respectivement la carte réseau dédiée au WAN de pfSense, et sa carte réseau LAN.

## Carte virtuelle vmbr1
✨ La carte virtuelle vmbr1 disposera d'une adresse IPv4 privée, et du routage (directement dans Proxmox) sera effectué entre la carte réseau physique enp8s0 et vmbr1. Son adresse IPv4 est `10.0.0.1/30` .


✨ J'ai configuré la carte réseau `vmbr1` dans le préfixe IPv6 donné par le fournisseur, j'ai attribué l'adresse IPv6 `2a01:4f8:192:4600::1/64` sans passerelle :

![[Pasted image 20241215213504.png]]


### Règles iptables



## Carte virtuelle vmbr2

✨ L'adresse IPv4 choisie pour cette carte est `192.168.50.1/24`. Le sous-réseau LAN du point de vue du firewall pfSense est donc `192.168.50.0/24`. 

Pourquoi ce sous-réseau ?

Car dans notre projet, nous allons déployer un tunnel VPN entre les machines des wilders, et ce sous-réseau, afin qu'ils puissent accéder au LAN pfSense depuis chez eux, et donc au serveur PnetLab.

De ce fait, il est nécessaire de différencier l'adressage réseau entre le LAN des wilders (chez eux), et le LAN pfSense, pour des raisons de routage. Imaginons que le sous-réseau LAN choisi pour pfSense soit un sous-réseau très habituel `192.168.1.0/24` . Il est fort probable que l'on retrouve ce sous-réseau aussi dans le LAN des wilders. Dans cette condition, il est impossible pour les machines des wilders de pouvoir joindre le LAN pfSense en passant par le VPN, car leurs machine ne peuvent pas différencier leur LAN du LAN de pfSense dans la destination (on essaye de joindre le LAN local ou le LAN pfSense, c'est la même destination !!!). Alors qu'avec un sous réseau de destination différent, la table de routage des machines des wilders peuvent avoir comme indication : si tu veux joindre le sous-réseau `192.168.50.1/0/24`, passe par le VPN. 


✨ Pour l'adresse IPv6 de la carte `vmbr2`, il est nécessaire de lui attribuer une adresse IPv6 dans un sous-réseau différent que celui de la carte `vmbr1`, car ce sera le sous-réseau du LAN pfSense. Ce sous-réseau doit faire parti de la plage /56 dont on dispose et sera en /64 (pfSense ne prend en charge que des préfixe de /64 pour son LAN).

![[Pasted image 20241215213532.png]]

✨ A partir de ce moment là, tu peux faire un test de connectivité IPv6 depuis ta machine (chez toi) sur l'adresse IPv6 de vmbr1 :

```bash
wilder@kaisen ~ $ ping -6 2a01:4f8:192:4600::1
PING 2a01:4f8:192:4600::1 (2a01:4f8:192:4600::1) 56 data bytes
64 bytes from 2a01:4f8:192:4600::1: icmp_seq=1 ttl=247 time=38.8 ms
64 bytes from 2a01:4f8:192:4600::1: icmp_seq=2 ttl=247 time=40.6 ms
``` 

## Règles iptables

Pour faire en sorte que cette configuration soit fonctionnelle étant donné les contraintes abordées en introduction, il faut créer des règles de redirection (forwarding). On en profite pour sécuriser un peu notre hyperviseur Proxmox, au niveau de ses accès réseaux, à l'aide de règles iptables.

Pourquoi créer des règles de forwarding ? Car lorsque l'hyperviseur Proxmox reçoit une requête de source externe (Internet), par exemple lors de l'établissement du tunnel VPN, il va recevoir la requête sur son interface physique `enp8s0` , adresse IPv4 publique. Il faut alors lui indique que, lorsqu'il reçoit ce genre de requête, il doit la rediriger vers l'interface vmbr1, et donc l'interface WAN du firewall pfSense. Mais attention, il faut quand même que l'on puisse administrer le Proxmox à distance, donc il faut créer une exception pour le port `22` (SSH, afin de pouvoir administrer le Proxmox via CLI), et le port `8006`(port d'administration web de Proxmox, par défaut).

De plus, on va pouvoir rendre ces règles facilement désactivable, si on les exécutes seulement lorsqu'on relance le démon networking via la commande `systemctl restart networking.service` . De cette façon, il suffira de commenter l'exécution des scripts dans le fichier `/etc/network/interfaces` et les règles ne s'appliqueront plus. Si on avait écrit les règles en dur, il aurait été compliqué de les désactiver. De ce fait, on rend la procédure plus simple.

Les 2 scripts bash qui seront joués sont `iptables.sh` et `pfsense-route.sh` :

```bash
root@wcs-ais-node1 ~ # cat /etc/network/interfaces
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

auto enp8s0
iface enp8s0 inet static
        address 144.76.100.132/27
        gateway 144.76.100.129
        up route add -net 144.76.100.128 netmask 255.255.255.224 gw 144.76.100.129 dev enp8s0
# route 144.76.100.128/27 via 144.76.100.129
#address 2a01:4f8:192:4082::2/56

iface enp8s0 inet6 static
        address 2a01:4f8:192:4082::2/64
        gateway fe80::1

auto vmbr1
iface vmbr1 inet static
        address 10.0.0.1/30
        bridge-ports none
        bridge-stp off
        bridge-fd 0
#WAN pfsense
        post-up /root/scripts/pfsense-route.sh
        post-up /root/scripts/iptables.sh

iface vmbr1 inet6 static
        address 2a01:4f8:192:4600::1/64

auto vmbr2
iface vmbr2 inet static
        address 192.168.50.1/24
        bridge-ports none
        bridge-stp off
        bridge-fd 0
#LAN pfsense

iface vmbr2 inet6 static
        address 2a01:4f8:192:4601::1/64
``` 


### Script iptables.sh

Le contenu du script est le suivant : 

```bash
root@wcs-ais-node1 ~ # cat /root/scripts/iptables.sh
#!/bin/sh
# ---------
# VARIABLES
# ---------
## Proxmox bridge holding Public IP
PrxPubVBR="enp8s0"
## Proxmox bridge on VmWanNET (PFSense WAN side)
PrxVmWanVBR="vmbr1"
## Proxmox bridge on PrivNET (PFSense LAN side)
PrxVmPrivVBR="vmbr2"
## Network/Mask of VmWanNET
VmWanNET="10.0.0.0/30"
## Network/Mmask of PrivNET
PrivNET="192.168.50.0/24"
## Network/Mmask of VpnNET
#VpnNET="172.31.0.0/16"
## Public IP => Your own public IP address
PublicIP=$(curl http://icanhazip.com -4 -s)
## Proxmox IP on the same network than PFSense WAN (VmWanNET)
ProxVmWanIP="10.0.0.1"
## Proxmox IP on the same network than VMs
ProxVmPrivIP="192.168.50.1"
## PFSense IP used by the firewall (inside VM)
PfsVmWanIP="10.0.0.2"
# ---------------------
# CLEAN ALL & DROP IPV6
# ---------------------
### Delete all existing rules.
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables -X
### This policy does not handle IPv6 traffic except to drop it.
#ip6tables -P INPUT DROP
#ip6tables -P OUTPUT DROP
#ip6tables -P FORWARD DROP
# --------------
# DEFAULT POLICY
# --------------
### Block ALL !
iptables -P OUTPUT DROP
iptables -P INPUT DROP
iptables -P FORWARD DROP
# ------
# CHAINS
# ------
### Creating chains
iptables -N TCP
iptables -N UDP
# UDP = ACCEPT / SEND TO THIS CHAIN
iptables -A INPUT -p udp -m conntrack --ctstate NEW -j UDP
# TCP = ACCEPT / SEND TO THIS CHAIN
iptables -A INPUT -p tcp --syn -m conntrack --ctstate NEW -j TCP
# ------------
# GLOBAL RULES
# ------------
# Allow localhost
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
# Don't break the current/active connections
iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Allow Ping - Comment this to return timeout to ping request
iptables -A INPUT -p icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
# --------------------
# RULES FOR PrxPubVBR
# --------------------
### INPUT RULES
# ---------------
# Allow SSH server
iptables -A TCP -i $PrxPubVBR -d $PublicIP -p tcp --dport 22 -j ACCEPT
# Allow Proxmox WebUI
iptables -A TCP -i $PrxPubVBR -d $PublicIP -p tcp --dport 8006 -j ACCEPT
### OUTPUT RULES
# ---------------
# Allow ping out
iptables -A OUTPUT -p icmp -j ACCEPT
### Proxmox Host as CLIENT
# Allow HTTP/HTTPS
iptables -A OUTPUT -o $PrxPubVBR -s $PublicIP -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -o $PrxPubVBR -s $PublicIP -p tcp --dport 443 -j ACCEPT
# Allow DNS
iptables -A OUTPUT -o $PrxPubVBR -s $PublicIP -p udp --dport 53 -j ACCEPT
### Proxmox Host as SERVER
# Allow SSH
iptables -A OUTPUT -o $PrxPubVBR -s $PublicIP -p tcp --sport 22 -j ACCEPT
# Allow PROXMOX WebUI
iptables -A OUTPUT -o $PrxPubVBR -s $PublicIP -p tcp --sport 8006 -j ACCEPT
### FORWARD RULES
# ----------------
### Redirect Wireguard
# Redirect UDP traffic on port 51820 to PFSense WAN - WIREGUARD
iptables -A PREROUTING -t nat -i $PrxPubVBR -d $PublicIP -p udp --dport 51820 -j DNAT --to-destination $PfsVmWanIP:51820
# Allow forwarded UDP traffic on port 51820 to reach PFSense WAN - WIREGUARD
iptables -A FORWARD -i $PrxPubVBR -d $PfsVmWanIP -p udp --dport 51820 -j ACCEPT
### Redirect (NAT) traffic from internet
# All tcp to PFSense WAN except 22, 8006
iptables -A PREROUTING -t nat -i $PrxPubVBR -p tcp --match multiport ! --dports 22,8006 -j DNAT --to $PfsVmWanIP
# All udp to PFSense WAN
iptables -A PREROUTING -t nat -i $PrxPubVBR -p udp -j DNAT --to $PfsVmWanIP
# Allow request forwarding to PFSense WAN interface
iptables -A FORWARD -i $PrxPubVBR -d $PfsVmWanIP -o $PrxVmWanVBR -p tcp -j ACCEPT
iptables -A FORWARD -i $PrxPubVBR -d $PfsVmWanIP -o $PrxVmWanVBR -p udp -j ACCEPT
# Allow request forwarding from LAN
iptables -A FORWARD -i $PrxVmWanVBR -s $VmWanNET -j ACCEPT
### MASQUERADE MANDATORY
# Allow WAN network (PFSense) to use vmbr0 public adress to go out
iptables -t nat -A POSTROUTING -s $VmWanNET -o $PrxPubVBR -j MASQUERADE
``` 



### Script pfsense-route.sh

```bash
root@wcs-ais-node1 ~ # cat /root/scripts/pfsense-route.sh
#!/bin/sh
## IP forwarding activation
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 1 > /proc/sys/net/ipv6/conf/all/forwarding
echo 1 > /proc/sys/net/ipv6/conf/all/autoconf
echo 1 > /proc/sys/net/ipv6/conf/all/accept_ra
#echo 1 > /proc/sys/net/ipv4/conf/eno1/proxy_arp
## Rediriger les paquets destinés au LAN pour l'interface WAN de la PFSense
ip route change 192.168.50.0/24 via 10.0.0.2 dev vmbr1
```


Bien sûr, ces 2 scripts sont rendu exécutables :
```bash
root@wcs-ais-node1 ~ # ls -l /root/scripts/
total 16
-rwxr-xr-x 1 root root 3932 Dec 10 08:38 iptables.sh
-rwxr-xr-x 1 root root  399 Dec 10 06:26 pfsense-route.sh
```


## Schéma réseau

![[Network_WCS-AIS-NODE1.excalidraw.png]]


